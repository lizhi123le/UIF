<template>
  <div class="app-container">
    <el-card class="box-card">
      <div slot="header" class="clearfix">
        <span>地址</span>
      </div>
      <el-form label-width="100px">
        <el-row :gutter="5">
          <el-col :xs="24" :sm="12" :md="8" :lg="6" :xl="6">
            <el-form-item label="API 地址">
              <el-input
                v-model="uif.user_manager.apiAddress"
                :placeholder="$translator({ cn: '必填', en: 'Required' })"
                v-on:change="SaveList()"
              ></el-input>
            </el-form-item>
          </el-col>

          <el-col :xs="24" :sm="12" :md="8" :lg="6" :xl="6">
            <el-form-item :label="$translator({ cn: '接口密码', en: 'Port' })">
              <el-input
                v-model="uif.user_manager.apiPwd"
                :placeholder="$translator({ cn: '必填', en: 'Required' })"
                v-on:change="SaveList()"
              ></el-input>
            </el-form-item>
          </el-col>
        </el-row>
      </el-form>
    </el-card>

    <el-card class="box-card">
      <div slot="header" class="clearfix">
        <span>
          服务器
          <el-divider direction="vertical"></el-divider>
          {{ uif.user_manager.nodesList.length }}({{ BuildTotalOnline() }})
          <el-divider direction="vertical"></el-divider>
          {{ BuildTotal(false) }}
          <el-divider direction="vertical"></el-divider>
          {{ BuildTotal(true) }}
        </span>

        <el-button
          style="float: right; margin-left: 10px; padding: 3px 0"
          @click="FlushNodes()"
          type="text"
          >{{ $translator({ cn: "刷新", en: "Run Testing" }) }}</el-button
        >

        <el-button
          style="float: right; margin-left: 10px; padding: 3px 0"
          @click="AddNode()"
          type="text"
          >{{ $translator({ cn: "添加", en: "Run Testing" }) }}</el-button
        >
      </div>

      <el-table
        :data="uif.user_manager.nodesList"
        stripe
        style="width: 100%"
        ref="filterTable"
      >
        <el-table-column
          :label="$translator({ cn: '启用', en: 'Enabled' })"
          min-width="50"
          align="center"
        >
          <template slot-scope="scope">
            <el-switch
              @click.native="enableUserOrNode(scope.row, 'node')"
              v-model="scope.row.enabled"
              :active-value="1"
              :inactive-value="0"
            >
            </el-switch>
          </template>
        </el-table-column>

        <el-table-column
          prop="name"
          :label="$translator({ cn: '名字', en: 'Name' })"
          min-width="150"
          align="center"
        >
          <template slot-scope="scope">
            {{ scope.row.name }}({{ scope.row.ipv4_address }})
          </template>
        </el-table-column>

        <el-table-column
          prop="online_user"
          :label="$translator({ cn: '在线', en: 'Proxy' })"
          min-width="40"
          align="center"
          sortable
        >
        </el-table-column>

        <el-table-column
          :label="$translator({ cn: '流量', en: 'Path' })"
          min-width="75"
          align="center"
          sortable
        >
          <template slot-scope="scope">
            <el-tag
              effect="plain"
              class="type_tag"
              type="info"
              disable-transitions
              >{{ BuildTraffic(scope.row.total_traffic) }}</el-tag
            >
            <el-tag
              effect="plain"
              class="type_tag"
              type="info"
              disable-transitions
              >{{ BuildTraffic(scope.row.week_traffic) }}</el-tag
            >
          </template>
        </el-table-column>

        <el-table-column
          label="最后更新"
          min-width="80"
          align="center"
          sortable
        >
          <template slot-scope="scope">
            {{ ParseTime(scope.row.last_seen_at) }}
          </template>
        </el-table-column>

        <el-table-column label="创建" min-width="80" align="center" sortable>
          <template slot-scope="scope">
            {{ ParseTime(scope.row.create_at) }}
          </template>
        </el-table-column>

        <el-table-column
          :label="$translator({ cn: '操作', en: 'Action' })"
          width="90"
          align="center"
        >
          <template slot-scope="scope">
            <el-dropdown trigger="click">
              <el-button type="primary" size="mini">
                {{ $translator({ cn: "操作", en: "Action" }) }}
                <i class="el-icon-arrow-down el-icon--right"></i>
              </el-button>
              <el-dropdown-menu slot="dropdown">
                <el-dropdown-item
                  icon="el-icon-edit-outline"
                  @click.native="handleNodeDetail(scope.row)"
                  >{{
                    $translator({ cn: "配置", en: "Config" })
                  }}</el-dropdown-item
                >

                <el-dropdown-item
                  icon="el-icon-refresh"
                  @click.native="Dispach(scope.row, 'DispachNode')"
                  >{{
                    $translator({ cn: "重新分配", en: "Config" })
                  }}</el-dropdown-item
                >
              </el-dropdown-menu>
            </el-dropdown>
          </template>
        </el-table-column>
      </el-table>
    </el-card>

    <el-card class="box-card">
      <div slot="header" class="clearfix">
        <span> 域名 </span>

        <el-button
          style="float: right; margin-left: 10px; padding: 3px 0"
          @click="FlushDomain()"
          type="text"
          >{{ $translator({ cn: "刷新", en: "Run Testing" }) }}</el-button
        >

        <el-button
          style="float: right; margin-left: 10px; padding: 3px 0"
          @click="AddDomain()"
          type="text"
          >{{ $translator({ cn: "添加", en: "Run Testing" }) }}</el-button
        >
      </div>

      <el-table
        :data="uif.user_manager.domainList"
        stripe
        style="width: 100%"
        ref="filterTable"
      >
        <el-table-column
          :label="$translator({ cn: '启用', en: 'Enabled' })"
          min-width="50"
          align="center"
        >
          <template slot-scope="scope">
            <el-switch
              @click.native="enableUserOrNode(scope.row, 'domain')"
              v-model="scope.row.enabled"
              :active-value="1"
              :inactive-value="0"
            >
            </el-switch>
          </template>
        </el-table-column>

        <el-table-column
          prop="name"
          :label="$translator({ cn: '名字', en: 'Name' })"
          min-width="150"
          align="center"
        >
          <template slot-scope="scope">
            {{ scope.row.id }}({{ scope.row.name }})
          </template>
        </el-table-column>

        <el-table-column
          prop="used"
          :label="$translator({ cn: '使用量', en: 'Name' })"
          min-width="150"
          align="center"
        >
        </el-table-column>

        <el-table-column
          label="最后更新"
          min-width="80"
          align="center"
          sortable
        >
          <template slot-scope="scope">
            {{ ParseTime(scope.row.last_seen_at) }}
          </template>
        </el-table-column>

        <el-table-column label="创建" min-width="80" align="center" sortable>
          <template slot-scope="scope">
            {{ ParseTime(scope.row.create_at) }}
          </template>
        </el-table-column>
      </el-table>
    </el-card>

    <el-card class="box-card">
      <div slot="header" class="clearfix">
        <span>
          订阅
          <el-divider direction="vertical"></el-divider>
          {{ uif.user_manager.usersList.length }}
        </span>

        <el-button
          style="float: right; margin-left: 10px; padding: 3px 0"
          @click="FlushUsers()"
          type="text"
          >{{ $translator({ cn: "刷新", en: "Run Testing" }) }}</el-button
        >
        <el-button
          style="float: right; margin-left: 10px; padding: 3px 0"
          @click="AddUser()"
          type="text"
          >{{ $translator({ cn: "添加", en: "Run Testing" }) }}</el-button
        >
      </div>

      <el-table
        :data="uif.user_manager.usersList"
        stripe
        style="width: 100%"
        ref="filterTable"
      >
        <el-table-column
          :label="$translator({ cn: '启用', en: 'Enabled' })"
          min-width="50"
          align="center"
        >
          <template slot-scope="scope">
            <el-switch
              @click.native="enableUserOrNode(scope.row, 'user')"
              v-model="scope.row.enabled"
              :active-value="1"
              :inactive-value="0"
            >
            </el-switch>
          </template>
        </el-table-column>

        <el-table-column
          :label="BuildUserStatusCount()"
          min-width="60"
          align="center"
          sortable
        >
          <template slot-scope="scope">
            <el-tag
              effect="plain"
              class="type_tag"
              :type="IsUserTimeout(scope.row) ? 'danger' : 'success'"
              disable-transitions
              >{{ IsUserTimeout(scope.row) ? "到期" : "可用" }}</el-tag
            >
          </template>
        </el-table-column>

        <el-table-column
          prop="name"
          :label="$translator({ cn: '名字', en: 'Name' })"
          min-width="150"
          align="center"
        >
          <template slot-scope="scope">
            {{ scope.row.name }}
          </template>
        </el-table-column>

        <el-table-column
          :label="$translator({ cn: '流量', en: 'Path' })"
          min-width="75"
          align="center"
          sortable
        >
          <template slot-scope="scope">
            <el-tag
              effect="plain"
              class="type_tag"
              type="info"
              disable-transitions
              >{{ BuildTraffic(scope.row.traffic_balance) }}</el-tag
            >
            <el-tag
              effect="plain"
              class="type_tag"
              type="info"
              disable-transitions
              >{{ BuildTraffic(scope.row.init_traffic) }}</el-tag
            >
          </template>
        </el-table-column>

        <el-table-column
          label="最后在线"
          min-width="80"
          align="center"
          sortable
        >
          <template slot-scope="scope">
            {{ ParseTime(scope.row.last_seen_at) }}
          </template>
        </el-table-column>

        <el-table-column label="到期" min-width="80" align="center" sortable>
          <template slot-scope="scope">
            {{ ParseTime(scope.row.expires_at) }}
          </template>
        </el-table-column>

        <el-table-column
          :label="$translator({ cn: '操作', en: 'Action' })"
          width="90"
          align="center"
        >
          <template slot-scope="scope">
            <el-dropdown trigger="click">
              <el-button type="primary" size="mini">
                {{ $translator({ cn: "操作", en: "Action" }) }}
                <i class="el-icon-arrow-down el-icon--right"></i>
              </el-button>
              <el-dropdown-menu slot="dropdown">
                <el-dropdown-item
                  icon="el-icon-edit-outline"
                  @click.native="handleUserDetail(scope.row)"
                  >{{
                    $translator({ cn: "配置", en: "Config" })
                  }}</el-dropdown-item
                >

                <el-dropdown-item
                  icon="el-icon-refresh"
                  @click.native="Dispach(scope.row, 'DispachUser')"
                  >{{
                    $translator({ cn: "重新分配", en: "Config" })
                  }}</el-dropdown-item
                >

                <el-dropdown-item
                  icon="el-icon-copy"
                  @click.native="CopyShare(scope.row)"
                  >{{
                    $translator({ cn: "复制订阅", en: "Config" })
                  }}</el-dropdown-item
                >
              </el-dropdown-menu>
            </el-dropdown>
          </template>
        </el-table-column>
      </el-table>
    </el-card>

    <el-dialog
      title="添加 / 修改节点"
      :visible.sync="uif.user_manager.isOpenAddNode"
      :fullscreen="true"
    >
      <add_node />
    </el-dialog>

    <el-dialog
      title="添加 / 修改用户"
      :visible.sync="uif.user_manager.isOpenAddUser"
      :fullscreen="true"
      v-if="uif.user_manager.isOpenAddUser"
    >
      <add_user />
    </el-dialog>

    <el-dialog
      title="添加 / 修改域名"
      :visible.sync="uif.user_manager.isOpenAddDomain"
      :fullscreen="true"
      v-if="uif.user_manager.isOpenAddDomain"
    >
      <add_domain />
    </el-dialog>
  </div>
</template>

<script>
import { mapActions, mapState } from "vuex";
import { IsObject, ParseTraffic } from "@/utils/index.js";
import moment from "moment";
import axios from "axios";
import { v4 as uuidv4 } from "uuid";
import { DeepCopy } from "@/utils";
import Cookies from "js-cookie";

import add_node from "./add_node.vue";
import add_user from "./add_user.vue";
import add_domain from "./add_domain.vue";

export default {
  name: "routing_list",
  components: { add_node, add_user, add_domain },
  data() {
    return {
      USER_MANAGE_ADDRESS: "USER_MANAGE_address",
      USER_MANAGE_pwd: "USER_MANAGE_pwd",
    };
  },
  computed: {
    ...mapState(["uif"]),
  },
  mounted() {
    var a = Cookies.get(this.USER_MANAGE_ADDRESS);
    if (a != null) {
      this.uif.user_manager.apiAddress = a;
    }
    var p = Cookies.get(this.USER_MANAGE_pwd);
    if (p != null) {
      this.uif.user_manager.apiPwd = p;
    }
    this.GetUIFConfig();
    this.FlushUsers();
    this.FlushNodes();
    this.FlushDomain();
  },
  methods: {
    ...mapActions({
      GetUIFConfig: "uif/GetUIFConfig",
      ApplyCoreConfig: "uif/ApplyCoreConfig",
      SaveUIFConfig: "uif/SaveUIFConfig",
    }),
    handleUserDetail(row) {
      this.AddUser();
      this.uif.user_manager.info = DeepCopy(row);
      this.uif.user_manager.info.traffic_balance =
        row.traffic_balance / 1000000000;
      this.uif.user_manager.info.init_traffic = row.init_traffic / 1000000000;
    },
    handleNodeDetail(row) {
      this.AddNode();
      this.uif.user_manager.info = row;
    },
    CopyShare(row) {
      var r = `https://${row.domain_id}/p?k=${row.id}`;
      var t = this;
      this.$copyText(r).then(
        function (e) {
          t.$message({
            showClose: true,
            message: "订阅 已复制到剪切板\n",
            type: "success",
          });
        },
        function (e) {},
      );
    },
    SaveList() {
      Cookies.set(this.USER_MANAGE_ADDRESS, this.uif.user_manager.apiAddress);
      Cookies.set(this.USER_MANAGE_pwd, this.uif.user_manager.apiPwd);
    },
    enableUserOrNode(row, method) {
      var e = "false";
      if (row.enabled == 1) {
        e = "true";
      }

      var t = this;
      const formData = new URLSearchParams();
      formData.append("key", this.uif.user_manager.apiPwd);
      formData.append("method", "EnableOrDisable");
      formData.append("id", row.id);
      formData.append("userOrNode", method);
      formData.append("enabled", e);
      axios
        .post(this.uif.user_manager.apiAddress, formData)
        .then((response) => {
          console.log(response);
          var data = response["data"];
          if ("status" in data && data["status"] == 0) {
            this.$message({
              type: "info",
              message: "更新成功",
            });
          }
        });
    },
    ParseTime(d) {
      return moment(d).fromNow();
    },
    BuildTraffic(data) {
      return ParseTraffic(data);
    },
    IsTimeout(row) {
      return ParseTraffic(data);
    },
    BuildTotalOnline(data) {
      var k = "online_user";
      var res = 0;
      for (var item in this.uif.user_manager.nodesList) {
        item = this.uif.user_manager.nodesList[item];
        if (k in item) {
          res += item[k];
        }
      }
      return res;
    },
    BuildFreeOrPaid() {
      var p = 0;
      var f = 0;
      for (var item in this.uif.user_manager.usersList) {
        item = this.uif.user_manager.usersList[item];
        if (item["type"] != 0) {
          p += 1;
        } else {
          f += 1;
        }
      }
      return `${f}/${p}`;
    },
    IsUserTimeout(item) {
      if (item.traffic_balance < 0 || item.expires_at < moment().valueOf()) {
        return true;
      }
      return false;
    },
    AddNode() {
      var nodeInfo = {
        id: uuidv4(),
        name: "",
        ipv4_address: "",
        ipv6_address: "",
        enabled: 1,
        node_type: 0,
        create_at: moment().valueOf(),
        last_seen_at: moment().valueOf(),
        total_traffic: 0,
        week_traffic: 0,
        online_user: 0,
        api_address: "",
        uif_address: "",
        uif_key: "",
      };
      this.uif.user_manager.info = nodeInfo;
      this.uif.user_manager.isOpenAddNode = true;
    },
    AddDomain() {
      var nodeInfo = {
        id: "",
        name: "",
        enabled: 1,
        used: 0,
        create_at: moment().valueOf(),
        last_seen_at: moment().valueOf(),
      };
      this.uif.user_manager.info = nodeInfo;
      this.uif.user_manager.isOpenAddDomain = true;
    },
    AddUser() {
      var userInfo = {
        id: uuidv4(),
        name: "",
        domain_id: "",
        enabled: 1,
        user_type: 0,
        is_banned: 0,
        expires_at: 0,
        last_seen_at: moment().valueOf(),
        traffic_balance: 0,
        init_traffic: 0,
      };
      this.uif.user_manager.info = userInfo;
      this.uif.user_manager.isOpenAddUser = true;
    },
    BuildUserStatusCount() {
      var p = 0;
      var f = 0;
      for (var item in this.uif.user_manager.usersList) {
        item = this.uif.user_manager.usersList[item];
        if (!this.IsUserTimeout(item)) {
          p += 1;
        } else {
          f += 1;
        }
      }
      return `${p}`;
    },
    BuildTotal(isWeek) {
      var k = "total_traffic";
      if (isWeek) {
        k = "week_traffic";
      }
      var res = 0;
      for (var item in this.uif.user_manager.nodesList) {
        item = this.uif.user_manager.nodesList[item];
        if (k in item) {
          res += item[k];
        }
      }
      return this.BuildTraffic(res);
    },
    FlushNodes() {
      var t = this;
      const formData = new URLSearchParams();
      formData.append("key", this.uif.user_manager.apiPwd);
      formData.append("method", "getAllNodes");
      axios
        .post(this.uif.user_manager.apiAddress, formData)
        .then((response) => {
          console.log(response);
          var data = response["data"];
          if ("status" in data && data["status"] == 0) {
            t.uif.user_manager.nodesList = data["res"];
            this.$message({
              type: "info",
              message: "更新成功",
            });
          }
        })
        .catch((err) => {
          this.$message({
            type: "error",
            message: "更新服务器失败",
          });
        });
    },
    FlushUsers() {
      var t = this;
      const formData = new URLSearchParams();
      formData.append("key", this.uif.user_manager.apiPwd);
      formData.append("method", "getAllUsers");
      axios
        .post(this.uif.user_manager.apiAddress, formData)
        .then((response) => {
          console.log(response);
          var data = response["data"];
          if ("status" in data && data["status"] == 0) {
            t.uif.user_manager.usersList = data["res"];
            this.$message({
              type: "info",
              message: "更新成功",
            });
          }
        })
        .catch((err) => {
          this.$message({
            type: "error",
            message: "更新用户失败",
          });
        });
    },
    FlushDomain() {
      var t = this;
      const formData = new URLSearchParams();
      formData.append("key", this.uif.user_manager.apiPwd);
      formData.append("method", "getAllDomains");
      axios
        .post(this.uif.user_manager.apiAddress, formData)
        .then((response) => {
          console.log(response);
          var data = response["data"];
          if ("status" in data && data["status"] == 0) {
            t.uif.user_manager.domainList = data["res"];
            this.$message({
              type: "info",
              message: "更新成功",
            });
          }
        })
        .catch((err) => {
          this.$message({
            type: "error",
            message: "更新域名失败",
          });
        });
    },
    Dispach(row, method) {
      const formData = new URLSearchParams();
      formData.append("key", this.uif.user_manager.apiPwd);
      formData.append("method", method);
      formData.append("id", row.id);
      axios
        .post(this.uif.user_manager.apiAddress, formData)
        .then((response) => {
          console.log(response);
          var data = response["data"];
          if ("status" in data && data["status"] == 0) {
            this.$message({
              type: "info",
              message: "更新成功",
            });
          }
        })
        .catch((error) => {
          this.$message({
            type: "error",
            message: "更新失败",
          });
        });
    },
    BuildInbound(row) {
      return row["metadata"]["type"];
    },
    BuildInfo(row) {
      var metadata = row["metadata"];
      var res = "";
      var host = metadata["host"];
      if (host != "" && host != undefined) {
        res += host;
      } else {
        var destinationIP = metadata["destinationIP"];
        if (destinationIP != "" && destinationIP != undefined) {
          res += destinationIP;
        }
      }
      var destinationPort = metadata["destinationPort"];
      if (destinationPort != "" && destinationPort != undefined) {
        res += ":" + destinationPort;
      }
      return res;
    },
  },
};
</script>

<style>
.group-card .el-card__header {
  padding: 8px 10px;
  -webkit-box-sizing: border-box;
  box-sizing: border-box;
}
/* <el-card> */
/*   <div slot="header" class="clearfix"> */
/*     <span>分组</span> */
/*   </div> */
/*   <el-row :gutter="5" class="group-card"> */
/*     <el-col :xs="12" :sm="8" :md="8" :lg="6" :xl="4"> */
/*       <el-card class="box-card"> */
/*         <div slot="header" class="clearfix"> */
/*           <span>分组</span> */
/*         </div> */
/*         sdfasdf */
/*       </el-card> */
/*     </el-col> */
/*   </el-row> */
/* </el-card> */
</style>
